#!/bin/bash

if [ "aa$1" == "aa--skip-disclaimer" ]; then
	SKIPDISCLAIMER="yes"
else
	SKIPDISCLAIMER="no"
fi

modules=`ls -d kernel/ez*`;

mkdir -p ./update/generated;

rm -f ./update/generated/publish_informix.sql;
rm -f ./update/generated/publish_postgresql.sql;
rm -f ./update/generated/publish_sqlite.sql;
rm -f ./update/generated/publish_mysql.sql;

if [ $SKIPDISCLAIMER == "no" ]; then

echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                                  #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/postgresql/[modulenname].sql instead   #
-- ################################################################
" >> ./update/generated/publish_postgresql.sql;

echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/mysql/[modulenname].sql instead        #
-- ################################################################
" >> ./update/generated/publish_mysql.sql;

echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/informix/[modulenname].sql instead     #
-- ################################################################
" >> ./update/generated/publish_informix.sql;

echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/mysql/[modulenname].sql instead        #
-- ################################################################
" >> ./update/generated/publish_sqlite.sql;
fi

for moduleDir in $modules
do
    module="${moduleDir##*/}";
    if [ -f kernel/$module/sql/postgresql/$module.sql ]
	then cat kernel/$module/sql/postgresql/$module.sql >> ./update/generated/publish_postgresql.sql;
    fi
    if [ -f kernel/$module/sql/mysql/$module.sql ]
	then cat kernel/$module/sql/mysql/$module.sql >> ./update/generated/publish_mysql.sql;
    fi
    if [ -f kernel/$module/sql/informix/$module.sql ]
	then cat kernel/$module/sql/informix/$module.sql >> ./update/generated/publish_informix.sql;
    fi
    #if [ -f kernel/$module/sql/sqlite/$module.sql ]
	#then cat kernel/$module/sql/sqlite/$module.sql >> ./update/generated/publish_sqlite.sql;
    #fi
    # mysqldump leaves trailing commas before closing parentheses  
        perl -0pe 's/,\n\)/\)/g' ./update/generated/publish_mysql.sql > ./update/generated/publish_sqlite.sql.tmp.stage1;

    # change all \' to ''
        sed -e 's/\\'\''/'\'''\''/g' ./update/generated/publish_sqlite.sql.tmp.stage1 > ./update/generated/publish_sqlite.sql;

    # split by prefix / finish up ...
        cp -a ./update/generated/publish_sqlite.sql ./update/generated/publish_sqlite.backup.sql;
done

# Display the generated files
ls -la ./update/generated/*;
echo "";
echo "Database Generation Complete. Please review your database content structure and creation scripts before using them.";

if [ $SKIPDISCLAIMER == "no" ]; then
	echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/postgresql/[modulenname].sql instead   #
-- ################################################################
" >> ./update/generated/publish_postgresql.sql

	echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/mysql/[modulenname].sql instead        #
-- ################################################################
" >> ./update/generated/publish_mysql.sql

echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/publish_informix/[modulenname].sql     #
-- # instead                                                      #
-- ################################################################
" >> ./update/generated/publish_informix.sql

	echo "
-- ################################################################
-- # Do not edit this file manually. This file is generated by    #
-- # db-generate.sh.sh                                            #
-- #                                                              #
-- # Any changes to this file will be lost in the release         #
-- # edit [modulename]/sql/sqlite/[modulenname].sql instead       #
-- ################################################################
" >> ./update/generated/publish_sqlite.sql
fi

